/*
 * graphics.c
 *
 *  Created on: 2025年12月8日
 *      Author: 0xaa55
 */

#include "graphics.h"
#include "utf8.h"
#include "font.h"

int space_size;
int tab_size;
const int font_height = 12;
const size_t num_font_codes = (sizeof font_code_table) / (sizeof font_code_table[0]);
const uint32_t min_code = font_code_table[0];
const uint32_t max_code = font_code_table[num_font_codes - 1];
const size_t font_bmp_pitch = sizeof font_bitmap / font_height;
uint16_t font_x_table[(sizeof font_width_table) / (sizeof font_width_table[0])];

typedef void(*fn_on_draw)(void *userdata, int x, int y, size_t char_index);
typedef int ssize_t;

typedef struct dtts
{
  Pixel565 text_color;
} DrawDataTransparent;

typedef struct dtos
{
  Pixel565 text_color;
  Pixel565 bg_color;
} DrawDataOpaque;

const HorzLine circle_60[] =
{
  {-60 ,-4 , 9 }, {-59 ,-12 , 25 }, {-58 ,-16 , 33 }, {-57 ,-19 , 39 },
  {-56 ,-22 , 45 }, {-55 ,-24 , 49 }, {-54 ,-26 , 53 }, {-53 ,-28 , 57 },
  {-52 ,-30 , 61 }, {-51 ,-32 , 65 }, {-50 ,-33 , 67 }, {-49 ,-35 , 71 },
  {-48 ,-36 , 73 }, {-47 ,-37 , 75 }, {-46 ,-38 , 77 }, {-45 ,-39 , 79 },
  {-44 ,-41 , 83 }, {-43 ,-42 , 85 }, {-42 ,-43 , 87 }, {-41 ,-44 , 89 },
  {-40 ,-44 , 89 }, {-39 ,-45 , 91 }, {-38 ,-46 , 93 }, {-37 ,-47 , 95 },
  {-36 ,-48 , 97 }, {-35 ,-49 , 99 }, {-34 ,-49 , 99 }, {-33 ,-50 , 101 },
  {-32 ,-51 , 103 }, {-31 ,-51 , 103 }, {-30 ,-52 , 105 }, {-29 ,-52 , 105 },
  {-28 ,-53 , 107 }, {-27 ,-53 , 107 }, {-26 ,-54 , 109 }, {-25 ,-54 , 109 },
  {-24 ,-55 , 111 }, {-23 ,-55 , 111 }, {-22 ,-56 , 113 }, {-21 ,-56 , 113 },
  {-20 ,-56 , 113 }, {-19 ,-57 , 115 }, {-18 ,-57 , 115 }, {-17 ,-57 , 115 },
  {-16 ,-58 , 117 }, {-15 ,-58 , 117 }, {-14 ,-58 , 117 }, {-13 ,-59 , 119 },
  {-12 ,-59 , 119 }, {-11 ,-59 , 119 }, {-10 ,-59 , 119 }, {-9 ,-59 , 119 },
  {-8 ,-59 , 119 }, {-7 ,-59 , 119 }, {-6 ,-59 , 119 }, {-5 ,-60 , 121 },
  {-4 ,-60 , 121 }, {-3 ,-60 , 121 }, {-2 ,-60 , 121 }, {-1 ,-60 , 121 },
  { 0 ,-60 , 121 }, { 1 ,-60 , 121 }, { 2 ,-60 , 121 }, { 3 ,-60 , 121 },
  { 4 ,-60 , 121 }, { 5 ,-60 , 121 }, { 6 ,-59 , 119 }, { 7 ,-59 , 119 },
  { 8 ,-59 , 119 }, { 9 ,-59 , 119 }, { 10 ,-59 , 119 }, { 11 ,-59 , 119 },
  { 12 ,-59 , 119 }, { 13 ,-59 , 119 }, { 14 ,-58 , 117 }, { 15 ,-58 , 117 },
  { 16 ,-58 , 117 }, { 17 ,-57 , 115 }, { 18 ,-57 , 115 }, { 19 ,-57 , 115 },
  { 20 ,-56 , 113 }, { 21 ,-56 , 113 }, { 22 ,-56 , 113 }, { 23 ,-55 , 111 },
  { 24 ,-55 , 111 }, { 25 ,-54 , 109 }, { 26 ,-54 , 109 }, { 27 ,-53 , 107 },
  { 28 ,-53 , 107 }, { 29 ,-52 , 105 }, { 30 ,-52 , 105 }, { 31 ,-51 , 103 },
  { 32 ,-51 , 103 }, { 33 ,-50 , 101 }, { 34 ,-49 , 99 }, { 35 ,-49 , 99 },
  { 36 ,-48 , 97 }, { 37 ,-47 , 95 }, { 38 ,-46 , 93 }, { 39 ,-45 , 91 },
  { 40 ,-44 , 89 }, { 41 ,-44 , 89 }, { 42 ,-43 , 87 }, { 43 ,-42 , 85 },
  { 44 ,-41 , 83 }, { 45 ,-39 , 79 }, { 46 ,-38 , 77 }, { 47 ,-37 , 75 },
  { 48 ,-36 , 73 }, { 49 ,-35 , 71 }, { 50 ,-33 , 67 }, { 51 ,-32 , 65 },
  { 52 ,-30 , 61 }, { 53 ,-28 , 57 }, { 54 ,-26 , 53 }, { 55 ,-24 , 49 },
  { 56 ,-22 , 45 }, { 57 ,-19 , 39 }, { 58 ,-16 , 33 }, { 59 ,-12 , 25 },
  { 60 ,-4 , 9 },
};
const HorzLine triangle_40[] =
{
  {-35 ,-20 , 1 }, {-34 ,-20 , 3 }, {-33 ,-20 , 5 }, {-32 ,-20 , 7 },
  {-31 ,-20 , 8 }, {-30 ,-20 , 10 }, {-29 ,-20 , 12 }, {-28 ,-20 , 13 },
  {-27 ,-20 , 15 }, {-26 ,-20 , 17 }, {-25 ,-20 , 19 }, {-24 ,-20 , 20 },
  {-23 ,-20 , 22 }, {-22 ,-20 , 24 }, {-21 ,-20 , 25 }, {-20 ,-20 , 27 },
  {-19 ,-20 , 29 }, {-18 ,-20 , 31 }, {-17 ,-20 , 32 }, {-16 ,-20 , 34 },
  {-15 ,-20 , 36 }, {-14 ,-20 , 37 }, {-13 ,-20 , 39 }, {-12 ,-20 , 41 },
  {-11 ,-20 , 43 }, {-10 ,-20 , 44 }, {-9 ,-20 , 46 }, {-8 ,-20 , 48 },
  {-7 ,-20 , 49 }, {-6 ,-20 , 51 }, {-5 ,-20 , 53 }, {-4 ,-20 , 55 },
  {-3 ,-20 , 56 }, {-2 ,-20 , 58 }, {-1 ,-20 , 60 }, { 0 ,-20 , 61 },
  { 1 ,-20 , 60 }, { 2 ,-20 , 58 }, { 3 ,-20 , 56 }, { 4 ,-20 , 54 },
  { 5 ,-20 , 53 }, { 6 ,-20 , 51 }, { 7 ,-20 , 49 }, { 8 ,-20 , 48 },
  { 9 ,-20 , 46 }, { 10 ,-20 , 44 }, { 11 ,-20 , 42 }, { 12 ,-20 , 41 },
  { 13 ,-20 , 39 }, { 14 ,-20 , 37 }, { 15 ,-20 , 36 }, { 16 ,-20 , 34 },
  { 17 ,-20 , 32 }, { 18 ,-20 , 30 }, { 19 ,-20 , 29 }, { 20 ,-20 , 27 },
  { 21 ,-20 , 25 }, { 22 ,-20 , 24 }, { 23 ,-20 , 22 }, { 24 ,-20 , 20 },
  { 25 ,-20 , 18 }, { 26 ,-20 , 17 }, { 27 ,-20 , 15 }, { 28 ,-20 , 13 },
  { 29 ,-20 , 12 }, { 30 ,-20 , 10 }, { 31 ,-20 , 8 }, { 32 ,-20 , 6 },
  { 33 ,-20 , 5 }, { 34 ,-20 , 3 }, { 35 ,-20 , 1 },
};

static HorzLine shutdown_50[] =
{
  {-60 ,-5 , 10 }, {-59 ,-5 , 10 }, {-58 ,-5 , 10 }, {-57 ,-5 , 10 },
  {-56 ,-5 , 10 }, {-55 ,-5 , 10 }, {-54 ,-5 , 10 }, {-53 ,-5 , 10 },
  {-52 ,-5 , 10 }, {-51 ,-5 , 10 }, {-50 ,-5 , 10 }, {-49 ,-5 , 10 },
  {-48 ,-5 , 10 }, {-47 ,-15 , 1 }, {-47 ,-5 , 10 }, {-47 , 14 , 2 },
  {-46 ,-17 , 5 }, {-46 ,-5 , 10 }, {-46 , 11 , 8 }, {-45 ,-19 , 8 },
  {-45 ,-5 , 10 }, {-45 , 11 , 10 }, {-44 ,-21 , 10 }, {-44 ,-5 , 10 },
  {-44 , 11 , 12 }, {-43 ,-23 , 13 }, {-43 ,-5 , 10 }, {-43 , 10 , 15 },
  {-42 ,-25 , 15 }, {-42 ,-5 , 10 }, {-42 , 10 , 17 }, {-41 ,-26 , 16 },
  {-41 ,-5 , 10 }, {-41 , 11 , 18 }, {-40 ,-29 , 18 }, {-40 ,-5 , 10 },
  {-40 , 11 , 19 }, {-39 ,-31 , 20 }, {-39 ,-5 , 10 }, {-39 , 12 , 19 },
  {-38 ,-32 , 19 }, {-38 ,-5 , 10 }, {-38 , 14 , 18 }, {-37 ,-33 , 18 },
  {-37 ,-5 , 10 }, {-37 , 16 , 17 }, {-36 ,-34 , 17 }, {-36 ,-5 , 10 },
  {-36 , 18 , 16 }, {-35 ,-34 , 15 }, {-35 ,-5 , 10 }, {-35 , 20 , 15 },
  {-34 ,-35 , 14 }, {-34 ,-5 , 10 }, {-34 , 22 , 14 }, {-33 ,-36 , 13 },
  {-33 ,-5 , 10 }, {-33 , 23 , 14 }, {-32 ,-37 , 13 }, {-32 ,-5 , 10 },
  {-32 , 24 , 14 }, {-31 ,-38 , 13 }, {-31 ,-5 , 10 }, {-31 , 25 , 14 },
  {-30 ,-39 , 13 }, {-30 ,-5 , 10 }, {-30 , 26 , 14 }, {-29 ,-40 , 13 },
  {-29 ,-5 , 10 }, {-29 , 27 , 14 }, {-28 ,-41 , 14 }, {-28 ,-5 , 10 },
  {-28 , 28 , 14 }, {-27 ,-41 , 13 }, {-27 ,-5 , 10 }, {-27 , 29 , 13 },
  {-26 ,-42 , 13 }, {-26 ,-5 , 10 }, {-26 , 30 , 13 }, {-25 ,-42 , 12 },
  {-25 ,-5 , 10 }, {-25 , 31 , 12 }, {-24 ,-43 , 12 }, {-24 ,-5 , 10 },
  {-24 , 32 , 12 }, {-23 ,-43 , 11 }, {-23 ,-5 , 10 }, {-23 , 33 , 12 },
  {-22 ,-43 , 10 }, {-22 ,-5 , 10 }, {-22 , 34 , 11 }, {-21 ,-44 , 10 },
  {-21 ,-5 , 10 }, {-21 , 35 , 10 }, {-20 ,-44 , 10 }, {-20 ,-5 , 10 },
  {-20 , 35 , 11 }, {-19 ,-45 , 10 }, {-19 ,-5 , 10 }, {-19 , 36 , 10 },
  {-18 ,-45 , 10 }, {-18 ,-5 , 10 }, {-18 , 36 , 11 }, {-17 ,-46 , 10 },
  {-17 ,-5 , 10 }, {-17 , 37 , 10 }, {-16 ,-46 , 10 }, {-16 ,-5 , 10 },
  {-16 , 37 , 10 }, {-15 ,-47 , 11 }, {-15 ,-5 , 10 }, {-15 , 38 , 10 },
  {-14 ,-47 , 10 }, {-14 ,-5 , 10 }, {-14 , 38 , 10 }, {-13 ,-48 , 11 },
  {-13 ,-5 , 10 }, {-13 , 39 , 10 }, {-12 ,-48 , 10 }, {-12 ,-5 , 10 },
  {-12 , 39 , 10 }, {-11 ,-48 , 10 }, {-11 ,-5 , 10 }, {-11 , 39 , 10 },
  {-10 ,-48 , 10 }, {-10 ,-5 , 10 }, {-10 , 39 , 10 }, {-9 ,-48 , 10 },
  {-9 ,-5 , 10 }, {-9 , 39 , 10 }, {-8 ,-49 , 10 }, {-8 ,-5 , 10 },
  {-8 , 40 , 10 }, {-7 ,-49 , 10 }, {-7 ,-5 , 10 }, {-7 , 40 , 10 },
  {-6 ,-49 , 10 }, {-6 ,-5 , 10 }, {-6 , 40 , 10 }, {-5 ,-49 , 10 },
  {-5 ,-5 , 10 }, {-5 , 40 , 10 }, {-4 ,-49 , 10 }, {-4 ,-5 , 10 },
  {-4 , 40 , 10 }, {-3 ,-49 , 10 }, {-3 ,-5 , 10 }, {-3 , 40 , 10 },
  {-2 ,-49 , 10 }, {-2 ,-5 , 10 }, {-2 , 40 , 10 }, {-1 ,-49 , 10 },
  {-1 ,-5 , 10 }, {-1 , 40 , 10 }, { 0 ,-50 , 10 }, { 0 ,-5 , 10 },
  { 0 , 40 , 10 }, { 1 ,-49 , 10 }, { 1 ,-4 , 9 }, { 1 , 40 , 10 },
  { 2 ,-49 , 10 }, { 2 ,-4 , 9 }, { 2 , 40 , 10 }, { 3 ,-49 , 10 },
  { 3 ,-3 , 7 }, { 3 , 40 , 10 }, { 4 ,-49 , 10 }, { 4 ,-2 , 5 },
  { 4 , 40 , 10 }, { 5 ,-49 , 10 }, { 5 , 40 , 10 }, { 6 ,-49 , 10 },
  { 6 , 40 , 10 }, { 7 ,-49 , 10 }, { 7 , 40 , 10 }, { 8 ,-49 , 10 },
  { 8 , 40 , 10 }, { 9 ,-49 , 10 }, { 9 , 40 , 10 }, { 10 ,-48 , 10 },
  { 10 , 39 , 10 }, { 11 ,-48 , 10 }, { 11 , 39 , 10 }, { 12 ,-48 , 10 },
  { 12 , 39 , 10 }, { 13 ,-47 , 10 }, { 13 , 38 , 10 }, { 14 ,-47 , 10 },
  { 14 , 38 , 10 }, { 15 ,-47 , 10 }, { 15 , 38 , 10 }, { 16 ,-46 , 10 },
  { 16 , 37 , 10 }, { 17 ,-46 , 10 }, { 17 , 37 , 10 }, { 18 ,-46 , 11 },
  { 18 , 36 , 11 }, { 19 ,-45 , 10 }, { 19 , 36 , 10 }, { 20 ,-45 , 11 },
  { 20 , 35 , 11 }, { 21 ,-44 , 10 }, { 21 , 35 , 10 }, { 22 ,-44 , 11 },
  { 22 , 34 , 11 }, { 23 ,-43 , 11 }, { 23 , 33 , 11 }, { 24 ,-43 , 12 },
  { 24 , 32 , 12 }, { 25 ,-42 , 11 }, { 25 , 32 , 11 }, { 26 ,-42 , 12 },
  { 26 , 31 , 12 }, { 27 ,-41 , 12 }, { 27 , 30 , 12 }, { 28 ,-41 , 13 },
  { 28 , 29 , 13 }, { 29 ,-40 , 13 }, { 29 , 28 , 13 }, { 30 ,-39 , 13 },
  { 30 , 27 , 13 }, { 31 ,-38 , 13 }, { 31 , 26 , 13 }, { 32 ,-38 , 15 },
  { 32 , 24 , 15 }, { 33 ,-37 , 15 }, { 33 , 23 , 15 }, { 34 ,-36 , 15 },
  { 34 , 22 , 15 }, { 35 ,-35 , 16 }, { 35 , 20 , 16 }, { 36 ,-34 , 17 },
  { 36 , 18 , 17 }, { 37 ,-33 , 18 }, { 37 , 16 , 18 }, { 38 ,-32 , 20 },
  { 38 , 13 , 20 }, { 39 ,-30 , 21 }, { 39 , 10 , 21 }, { 40 ,-29 , 59 },
  { 41 ,-28 , 57 }, { 42 ,-26 , 53 }, { 43 ,-24 , 49 }, { 44 ,-22 , 45 },
  { 45 ,-20 , 41 }, { 46 ,-18 , 37 }, { 47 ,-15 , 31 }, { 48 ,-12 , 25 },
  { 49 ,-9 , 19 },
};

static HorzLine gear_45[] =
{
  {-45 ,-8 , 9 }, {-44 ,-12 , 13 }, {-43 ,-15 , 16 }, {-43 , 13 , 3 },
  {-42 ,-14 , 15 }, {-42 , 13 , 5 }, {-41 ,-14 , 15 }, {-41 , 13 , 7 },
  {-40 ,-14 , 15 }, {-40 , 12 , 10 }, {-39 ,-13 , 14 }, {-39 , 12 , 12 },
  {-38 ,-13 , 14 }, {-38 , 12 , 14 }, {-37 ,-13 , 14 }, {-37 , 11 , 16 },
  {-36 ,-27 , 2 }, {-36 ,-12 , 13 }, {-36 , 11 , 16 }, {-35 ,-29 , 4 },
  {-35 ,-12 , 19 }, {-35 , 11 , 15 }, {-34 ,-30 , 6 }, {-34 ,-12 , 38 },
  {-33 ,-31 , 8 }, {-33 ,-14 , 39 }, {-32 ,-32 , 10 }, {-32 ,-16 , 40 },
  {-31 ,-33 , 11 }, {-31 ,-17 , 41 }, {-30 ,-34 , 13 }, {-30 ,-19 , 42 },
  {-29 ,-35 , 57 }, {-28 ,-35 , 58 }, {-27 ,-36 , 60 }, {-26 ,-36 , 61 },
  {-26 , 35 , 3 }, {-25 ,-36 , 62 }, {-25 , 33 , 6 }, {-24 ,-35 , 62 },
  {-24 , 32 , 7 }, {-23 ,-33 , 61 }, {-23 , 30 , 10 }, {-22 ,-32 , 72 },
  {-21 ,-30 , 71 }, {-20 ,-29 , 70 }, {-19 ,-30 , 27 }, {-19 , 3 , 39 },
  {-18 ,-30 , 23 }, {-18 , 7 , 35 }, {-17 ,-31 , 22 }, {-17 , 10 , 33 },
  {-16 ,-31 , 21 }, {-16 , 11 , 32 }, {-15 ,-32 , 20 }, {-15 , 13 , 31 },
  {-14 ,-43 , 4 }, {-14 ,-32 , 19 }, {-14 , 14 , 30 }, {-13 ,-43 , 7 },
  {-13 ,-33 , 19 }, {-13 , 15 , 29 }, {-12 ,-43 , 28 }, {-12 , 16 , 25 },
  {-11 ,-44 , 29 }, {-11 , 16 , 22 }, {-10 ,-44 , 28 }, {-10 , 17 , 18 },
  {-9 ,-44 , 27 }, {-9 , 18 , 17 }, {-8 ,-44 , 27 }, {-8 , 18 , 17 },
  {-7 ,-45 , 27 }, {-7 , 19 , 16 }, {-6 ,-45 , 27 }, {-6 , 19 , 17 },
  {-5 ,-45 , 27 }, {-5 , 19 , 17 }, {-4 ,-45 , 27 }, {-4 , 19 , 17 },
  {-3 ,-45 , 26 }, {-3 , 20 , 16 }, {-2 ,-45 , 26 }, {-2 , 20 , 16 },
  {-1 ,-45 , 26 }, {-1 , 20 , 26 }, { 0 ,-45 , 26 }, { 0 , 20 , 26 },
  { 1 ,-35 , 16 }, { 1 , 20 , 26 }, { 2 ,-35 , 16 }, { 2 , 20 , 26 },
  { 3 ,-35 , 16 }, { 3 , 20 , 26 }, { 4 ,-35 , 17 }, { 4 , 19 , 27 },
  { 5 ,-35 , 17 }, { 5 , 19 , 27 }, { 6 ,-35 , 17 }, { 6 , 19 , 27 },
  { 7 ,-34 , 16 }, { 7 , 19 , 27 }, { 8 ,-34 , 17 }, { 8 , 18 , 27 },
  { 9 ,-34 , 17 }, { 9 , 18 , 27 }, { 10 ,-34 , 18 }, { 10 , 17 , 28 },
  { 11 ,-37 , 22 }, { 11 , 16 , 29 }, { 12 ,-40 , 25 }, { 12 , 16 , 28 },
  { 13 ,-43 , 29 }, { 13 , 15 , 19 }, { 13 , 37 , 7 }, { 14 ,-43 , 30 },
  { 14 , 14 , 19 }, { 14 , 40 , 4 }, { 15 ,-43 , 31 }, { 15 , 13 , 20 },
  { 16 ,-42 , 32 }, { 16 , 11 , 21 }, { 17 ,-42 , 33 }, { 17 , 9 , 23 },
  { 18 ,-41 , 34 }, { 18 , 7 , 24 }, { 19 ,-41 , 38 }, { 19 , 3 , 28 },
  { 20 ,-40 , 70 }, { 21 ,-40 , 71 }, { 22 ,-39 , 72 }, { 23 ,-39 , 10 },
  { 23 ,-27 , 61 }, { 24 ,-38 , 7 }, { 24 ,-26 , 62 }, { 25 ,-38 , 6 },
  { 25 ,-25 , 62 }, { 26 ,-37 , 3 }, { 26 ,-24 , 61 }, { 27 ,-23 , 60 },
  { 28 ,-22 , 58 }, { 29 ,-21 , 57 }, { 30 ,-22 , 42 }, { 30 , 22 , 13 },
  { 31 ,-23 , 41 }, { 31 , 22 , 12 }, { 32 ,-23 , 39 }, { 32 , 23 , 10 },
  { 33 ,-24 , 38 }, { 33 , 24 , 8 }, { 34 ,-25 , 37 }, { 34 , 25 , 6 },
  { 35 ,-25 , 15 }, { 35 ,-7 , 20 }, { 35 , 25 , 5 }, { 36 ,-26 , 16 },
  { 36 ,-1 , 14 }, { 36 , 26 , 2 }, { 37 ,-26 , 15 }, { 37 ,-1 , 14 },
  { 38 ,-25 , 14 }, { 38 ,-1 , 15 }, { 39 ,-23 , 12 }, { 39 ,-1 , 15 },
  { 40 ,-21 , 9 }, { 40 ,-1 , 15 }, { 41 ,-20 , 8 }, { 41 ,-1 , 16 },
  { 42 ,-18 , 6 }, { 42 ,-1 , 16 }, { 43 ,-16 , 3 }, { 43 ,-1 , 16 },
  { 44 ,-1 , 13 }, { 45 ,-1 , 9 },
};

static ssize_t GetCharIndex(uint32_t unicode)
{
  ssize_t max_index = (ssize_t)num_font_codes - 1;
  ssize_t min_index = 0;
  if (unicode < min_code || unicode > max_code) return -1;
  ssize_t ci = (size_t)(num_font_codes) >> 1;
  for (;;)
  {
    uint32_t cur_code = font_code_table[ci];
    if (cur_code == unicode) return ci;
    if (cur_code < unicode)
      min_index = ci;
    else
      max_index = ci;
    if (max_index - 1 == min_index) return -1;
    ci = (max_index + min_index) >> 1;
  }
}

static size_t GetCharIndexMust(uint32_t unicode)
{
  ssize_t ci = GetCharIndex(unicode);
  if (ci < 0) ci = GetCharIndex('?');
  if (ci < 0) ci = 0;
  return (size_t) ci;
}

static int SampleFont(int x, int y)
{
  return (font_bitmap[y * font_bmp_pitch + x / 8] & (0x80 >> (x & 7))) != 0;
}

static void Compose(int x, int y, int r, int b, const char* text, fn_on_draw on_draw, void *userdata)
{
  int cur_x = x, cur_y = y;
  UTF8Parser parser = utf8_start_parse(text);
  uint32_t code;
  size_t char_index;
  int char_width;
  for(;;)
  {
    code = utf8_to_utf32(&parser, '?');
    if (!code) break;
    if (code == '\n')
    {
      cur_x = x;
      cur_y += font_height;
      continue;
    }
    if (code == '\t')
    {
      cur_x += ((cur_x - x) / tab_size + 1) * tab_size;
      continue;
    }
    char_index = GetCharIndexMust(code);
    char_width = font_width_table[char_index];
    if (cur_x + char_width > r)
    {
      cur_x = x;
      cur_y += font_height;
    }
    if (cur_y + font_height - 1 > b) break;
    on_draw(userdata, cur_x, cur_y, char_index);
    cur_x += char_width;
  }
  utf8_end_parse(&parser);
}

void Graphics_Init()
{
  int space_char_index = GetCharIndex(' ');
  uint16_t x = 0;
  for (size_t i = 0; i < num_font_codes; i++)
  {
    font_x_table[i] = x;
    x += font_width_table[i];
  }
  space_size = font_width_table[space_char_index];
  tab_size = space_size * 4;
}

Pixel565 ColorFromPhase(uint32_t phase, uint32_t brightness, uint32_t colorness)
{
  uint32_t phase_value = phase % 1536;
  uint32_t r, g, b;
  uint32_t grey;
  if (phase_value <= 255)
  {
    r = 255;
    g = phase_value;
    b = 0;
  }
  else if (phase_value <= 511)
  {
    r = 511 - phase_value;
    g = 255;
    b = 0;
  }
  else if (phase_value <= 767)
  {
    r = 0;
    g = 255;
    b = phase_value - 512;
  }
  else if (phase_value <= 1023)
  {
    r = 0;
    g = 1023 - phase_value;
    b = 255;
  }
  else if (phase_value <= 1279)
  {
    r = phase_value - 1024;
    g = 0;
    b = 255;
  }
  else
  {
    r = 255;
    g = 0;
    b = 1535 - phase_value;
  }
  if (brightness > 256)
  {
    if (brightness > 511) brightness = 511;
    int gain = brightness - 256;
    int dim = 256 - gain;
    r = r * dim / 256 + gain;
    g = g * dim / 256 + gain;
    b = b * dim / 256 + gain;
  }
  else
  {
    r = r * brightness / 256;
    g = g * brightness / 256;
    b = b * brightness / 256;
  }
  grey = (r + g + b) / 3;
  if (colorness > 256) colorness = 256;
  r = FixedInterpolate(grey, r, colorness, 256);
  g = FixedInterpolate(grey, g, colorness, 256);
  b = FixedInterpolate(grey, b, colorness, 256);
  return MakePixel565(r, g, b);
}

static void on_draw_transparent(void *userdata, int x, int y, size_t char_index)
{
  DrawDataTransparent *dt = (DrawDataTransparent*)userdata;
  int char_width = font_width_table[char_index];
  int char_x = font_x_table[char_index];
  for (int iy = 0; iy < font_height; iy ++)
  {
    for (int ix = 0; ix < char_width; ix ++)
    {
      int dx = (x + ix) % 320;
      int dy = (y + iy) % 240;
      if (SampleFont(char_x + ix, iy))
        CurDrawFramebuffer[dy][dx] = dt->text_color;
    }
  }
}

static void on_draw_opaque(void *userdata, int x, int y, size_t char_index)
{
  DrawDataOpaque *dt = (DrawDataOpaque*)userdata;
  int char_width = font_width_table[char_index];
  int char_x = font_x_table[char_index];
  for (int iy = 0; iy < font_height; iy ++)
  {
    for (int ix = 0; ix < char_width; ix ++)
    {
      int dx = (x + ix) % 320;
      int dy = (y + iy) % 240;
      if (SampleFont(char_x + ix, iy))
        CurDrawFramebuffer[dy][dx] = dt->text_color;
      else
        CurDrawFramebuffer[dy][dx] = dt->bg_color;
    }
  }
}

void DrawText(int x, int y, const char* text, Pixel565 text_color)
{
  DrawDataTransparent dt;
  dt.text_color = text_color;
  Compose(x, y, 319, 239, text, on_draw_transparent, &dt);
}

void DrawTextOpaque(int x, int y, const char* text, Pixel565 text_color, Pixel565 bg_color)
{
  DrawDataOpaque dt;
  dt.text_color = text_color;
  dt.bg_color = bg_color;
  Compose(x, y, 319, 239, text, on_draw_opaque, &dt);
}

void DrawHorzLines(int x_center, int y_center, const HorzLine *lines, size_t count, Pixel565 color, int scaling)
{
  if (scaling <= 0) return;
  for(size_t i = 0; i < count; i++)
  {
    int y = y_center + lines[i].y_offset * scaling / 512;
    int x = x_center + lines[i].x_offset * scaling / 512;
    int l = lines[i].x_length * scaling / 512;
    if (y < 0 || y >= 240) continue;
    if (x < 0)
    {
      l += x;
      x = 0;
    }
    if (x + l >= 320)
    {
      l = 319 - x;
      if (l <= 0) continue;
    }
    for (int ix = 0; ix < l; ix ++)
      CurDrawFramebuffer[y][ix + x] = color;
  }
}

void DrawPlayButton(int x_center, int y_center, Pixel565 c1, Pixel565 c2, int scaling)
{
  DrawHorzLines(x_center, y_center, circle_60, (sizeof circle_60) / (sizeof circle_60[0]), c1, scaling);
  DrawHorzLines(x_center, y_center, triangle_40, (sizeof triangle_40) / (sizeof triangle_40[0]), c2, scaling);
}

void DrawOptionButton(int x_center, int y_center, Pixel565 c1, Pixel565 c2, int scaling)
{
  DrawHorzLines(x_center, y_center, circle_60, (sizeof circle_60) / (sizeof circle_60[0]), c1, scaling);
  DrawHorzLines(x_center, y_center, gear_45, (sizeof gear_45) / (sizeof gear_45[0]), c2, scaling);
}

void DrawShutdownButton(int x_center, int y_center, Pixel565 color, int scaling)
{
  DrawHorzLines(x_center, y_center, shutdown_50, (sizeof shutdown_50) / (sizeof shutdown_50[0]), color, scaling);
}
